# Docker Quickstart Guide

## TL;DR

```bash
# On your Mac
git pull origin claude/continue-work-011CUkRmXtm24f1Qc3mHbrGJ
cp .env.example .env
# Edit .env and add your NASDAQ_DATA_LINK_API_KEY
docker compose build
docker compose up -d
open http://localhost:9000
```

Then open the notebook: `notebooks/01_quickstart_sharadar_flightlog.ipynb`

---

## Step-by-Step Setup

### 1. Pull Latest Changes (On Your Mac)

```bash
cd /path/to/zipline-reloaded
git checkout claude/continue-work-011CUkRmXtm24f1Qc3mHbrGJ
git pull origin claude/continue-work-011CUkRmXtm24f1Qc3mHbrGJ
```

**Verify you have the files:**
```bash
ls -lh Dockerfile docker-compose.yml extension.py
ls -lh notebooks/01_quickstart_sharadar_flightlog.ipynb
```

### 2. Configure Environment

```bash
# Copy template
cp .env.example .env

# Edit and add your API key
nano .env  # or use your favorite editor
```

**In `.env`, set:**
```bash
NASDAQ_DATA_LINK_API_KEY=your_api_key_here
```

Get your API key at: https://data.nasdaq.com/sign-up

### 3. Build Docker Containers

```bash
docker compose build
```

**This takes 5-10 minutes first time.**

The build now:
- ‚úÖ Installs Zipline with all dependencies
- ‚úÖ **Automatically copies `extension.py` to `~/.zipline/extension.py`**
- ‚úÖ Registers Sharadar bundle
- ‚úÖ Installs Jupyter Lab with plotting libraries

### 4. Start Services

```bash
docker compose up -d
```

This starts:
- **Jupyter Lab**: http://localhost:9000
- **FlightLog Server**: localhost:9020

### 5. Verify Setup

**Open a second terminal and run:**
```bash
# Exec into the container
docker compose exec zipline-jupyter bash

# Run verification script
python scripts/verify_setup.py
```

**Expected output:**
```
============================================================
Zipline Setup Verification
============================================================
1. Checking Zipline installation...
   ‚úÖ Zipline installed (version: 3.1.1)

2. Checking extension.py file...
   ‚úÖ Extension file exists: /root/.zipline/extension.py
   ‚úÖ Extension file contains sharadar_bundle

3. Checking sharadar_bundle module...
   ‚úÖ sharadar_bundle module loads successfully

4. Checking bundle registration...
   Registered bundles: ['sharadar', 'sharadar-equities', 'sharadar-tech', ...]
   ‚úÖ Sharadar bundle is registered!

...

Passed: 7/7

‚úÖ Setup looks good! You can run backtests.
```

### 6. Ingest Data (First Time Only)

**Still in the container:**
```bash
zipline ingest -b sharadar
```

**‚è∞ First ingestion takes 60-90 minutes** (downloads 1998-present)

**‚òï Get some coffee!** Future updates will only take 2-5 minutes.

**Progress output:**
```
Sharadar Bundle Ingestion
==========================================================
  Date Range: 1998-01-01 to 2025-11-03
  Tickers: All available (~8,000+)
  Tables: SEP (equities), SFP (funds), ACTIONS (corp actions)

Step 1/4: Downloading Sharadar Equity Prices (SEP table)...
  ‚ö†Ô∏è  Dataset too large for get_table(), using bulk export API...
  ‚è≥ File is being generated by NASDAQ servers...
     This can take 60-90 minutes for full historical data (1998-present)
     Please wait...
```

**Monitor progress:**
```bash
# In another terminal
docker logs -f zipline-reloaded-jupyter
```

### 7. Open Jupyter and Run Quickstart Notebook

1. **Open Jupyter**: http://localhost:9000
2. **Navigate to**: `notebooks/01_quickstart_sharadar_flightlog.ipynb`
3. **Run all cells** (Shift+Enter or Run ‚Üí Run All Cells)

The notebook will:
- ‚úÖ Verify bundle is registered
- ‚úÖ Check data is ingested
- ‚úÖ Connect to FlightLog
- ‚úÖ Run a simple AAPL buy-and-hold backtest
- ‚úÖ Plot results

### 8. Watch FlightLog in Real-Time (Optional)

**Open a third terminal:**
```bash
docker logs -f zipline-flightlog
```

You'll see colorized logs streaming in real-time:
```
[2025-11-03 12:00:00] [INFO] üöÄ Initializing QuickStart strategy
[2025-11-03 12:00:00] [INFO] Configuration: Buy and hold AAPL
[2025-11-03 12:00:01] [INFO] üìà Purchased AAPL at 150.25
...
[2025-11-03 12:05:00] [INFO] ‚úÖ Backtest completed!
```

---

## Troubleshooting

### Problem: "UnknownBundle: No bundle registered with the name 'sharadar'"

**Cause:** Extension.py not loaded or Sharadar bundle code missing.

**Solution:**

1. **Verify extension.py exists in container:**
   ```bash
   docker compose exec zipline-jupyter cat ~/.zipline/extension.py
   ```

2. **Restart Jupyter kernel:**
   - In Jupyter: Kernel ‚Üí Restart Kernel

3. **Rebuild container:**
   ```bash
   docker compose down
   docker compose build --no-cache
   docker compose up -d
   ```

4. **Run verification script:**
   ```bash
   docker compose exec zipline-jupyter python scripts/verify_setup.py
   ```

### Problem: Persistent volume data not found after restart

**Cause:** Docker volume configuration issue.

**Check volume:**
```bash
docker volume ls | grep zipline
```

**Should see:**
```
local     zipline-reloaded_zipline-data
```

**Mount point in container:** `/root/.zipline`

**Check data persists:**
```bash
# Before restart
docker compose exec zipline-jupyter ls -lh ~/.zipline/data/

# After restart
docker compose restart
docker compose exec zipline-jupyter ls -lh ~/.zipline/data/
```

Data should still be there!

**If data is missing:**
1. Check `docker-compose.yml` has:
   ```yaml
   volumes:
     - zipline-data:/root/.zipline
   ```

2. Don't use `-v` flag when running `docker compose down`:
   ```bash
   docker compose down      # ‚úÖ Keeps volumes
   docker compose down -v   # ‚ùå DELETES volumes!
   ```

### Problem: FlightLog not connecting

**Check FlightLog is running:**
```bash
docker ps | grep flightlog
```

**Check logs:**
```bash
docker logs zipline-flightlog
```

**Should see:**
```
FlightLog Server Starting...
Host: 0.0.0.0
Port: 9020
Log file: /logs/flightlog.log
Listening for connections...
```

**Restart FlightLog:**
```bash
docker compose restart flightlog
```

### Problem: Build fails with "No such file: extension.py"

**Cause:** extension.py missing from project root.

**Solution:**
```bash
# Verify file exists
ls -lh extension.py

# If missing, pull again
git checkout claude/continue-work-011CUkRmXtm24f1Qc3mHbrGJ -- extension.py
```

---

## What's in the Docker Setup

### Services

1. **zipline-jupyter** (Main service)
   - Jupyter Lab on port 9000
   - Zipline with Sharadar bundle
   - Progress logging & FlightLog client
   - All dependencies installed

2. **flightlog** (Optional log viewer)
   - TCP server on port 9020
   - Real-time log streaming
   - Colorized output

### Volumes

```yaml
volumes:
  # Project notebooks (on your Mac)
  - ./notebooks:/notebooks

  # Zipline data (PERSISTENT - survives restarts)
  - zipline-data:/root/.zipline

  # Data directory
  - ./data:/data

  # Scripts
  - ./scripts:/scripts

  # Examples
  - ./examples:/app/examples
```

**Important:**
- `zipline-data` volume is **persistent** - your ingested data survives container restarts
- Only destroyed if you run `docker compose down -v` (DON'T DO THIS unless you want to delete data!)

---

## Daily Workflow

### Start Services
```bash
docker compose up -d
```

### Update Data (Daily)
```bash
docker compose exec zipline-jupyter zipline ingest -b sharadar
```
Takes 2-5 minutes for incremental update.

### Open Jupyter
http://localhost:9000

### Stop Services
```bash
docker compose down  # Keeps data
```

### Check Logs
```bash
# Jupyter logs
docker logs -f zipline-reloaded-jupyter

# FlightLog
docker logs -f zipline-flightlog
```

---

## Next Steps

1. **Run the quickstart notebook:**
   - `notebooks/01_quickstart_sharadar_flightlog.ipynb`

2. **Try the examples:**
   ```bash
   docker compose exec zipline-jupyter python examples/momentum_strategy_with_flightlog.py
   ```

3. **Read the docs:**
   - `docs/FLIGHTLOG_BEST_PRACTICES.md` - FlightLog patterns
   - `docs/SHARADAR_GUIDE.md` - Sharadar usage
   - `docs/SHARADAR_INCREMENTAL_UPDATES.md` - Incremental updates
   - `GETTING_STARTED.md` - General guide

4. **Build your own strategies!**

---

## Summary

‚úÖ **Extension.py is now auto-installed during Docker build**
‚úÖ **Sharadar bundle auto-registered on container startup**
‚úÖ **Quickstart notebook guides you through first backtest**
‚úÖ **Setup verification script checks everything**
‚úÖ **Persistent volumes keep your data between restarts**

The "UnknownBundle" error is fixed! Just rebuild:
```bash
docker compose down
docker compose build
docker compose up -d
```
