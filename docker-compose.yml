services:
  zipline-jupyter:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: zipline-reloaded-jupyter
    ports:
      - "${JUPYTER_PORT:-9000}:8888"  # Jupyter Lab (host:container)
    volumes:
      # Mount data directory for persistence (ONLY data persists)
      - ./data:/data
      # Mount zipline data (bundles stored here - persistent across restarts)
      - zipline-data:/root/.zipline
      # Mount pip cache for faster rebuilds
      - pip-cache:/root/.cache/pip
    environment:
      - ZIPLINE_ROOT=/root/.zipline
      - ZIPLINE_CUSTOM_DATA_DIR=/data/custom_databases
      - PYTHONUNBUFFERED=1
      # FlightLog configuration
      - FLIGHTLOG_HOST=flightlog
      - FLIGHTLOG_PORT=9020
      # API keys from .env file (optional)
      - NASDAQ_DATA_LINK_API_KEY=${NASDAQ_DATA_LINK_API_KEY:-}
      - ALPHA_VANTAGE_API_KEY=${ALPHA_VANTAGE_API_KEY:-}
      - IEX_CLOUD_API_KEY=${IEX_CLOUD_API_KEY:-}
      - POLYGON_API_KEY=${POLYGON_API_KEY:-}
    env_file:
      - .env
    restart: unless-stopped
    networks:
      - zipline-network

  flightlog:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: zipline-flightlog
    command: python /app/scripts/flightlog.py --host 0.0.0.0 --file /logs/flightlog.log
    ports:
      - "${FLIGHTLOG_PORT:-9020}:9020"
    volumes:
      # Mount logs directory for persistent log files
      - ./logs:/logs
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - zipline-network
    # Auto-start with docker compose up
    restart: unless-stopped
    stdin_open: true
    tty: true

volumes:
  zipline-data:
    driver: local
  pip-cache:
    driver: local

networks:
  zipline-network:
    driver: bridge
